#!/bin/bash

# Deploys manifests from k8s/ directory to sminnee-prod namespace
# Requires that kubectl is authenticated

TAGPREFIX=""

NAMESPACE=sminnee-prod
DEPLOYMENT=www

if [ "$1" = "" ]; then
    echo "Usage: $0 (tag)"
    exit 1
fi

if [ "$LINODE_DEPLOY_KEY" = "" ]; then
  echo "Set LINODE_DEPLOY_KEY env var to the OpenSSL private key Kubernetes access"
  exit 2
fi

echo "$LINODE_DEPLOY_KEY" > bin/github-deploy.key

# Apply all manifests with image tag substitution
export IMAGE_TAG="$TAGPREFIX$1"
for file in k8s/common/*.yaml k8s/prod/*.yaml; do
  envsubst '$IMAGE_TAG' < "$file" | KUBECONFIG=bin/kubeconfig.yaml kubectl apply -f - -n $NAMESPACE
done

# Wait for rollout to complete
KUBECONFIG=bin/kubeconfig.yaml kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=60s

if [ "$?" != "0" ]; then
  echo "Rolling back"
  KUBECONFIG=bin/kubeconfig.yaml kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE
  rm bin/github-deploy.key
  exit 1
fi

rm bin/github-deploy.key
